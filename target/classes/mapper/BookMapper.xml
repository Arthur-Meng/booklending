<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hundsun.booklending.mapper.BookMapper">


	<insert id="saveBook" parameterType="book">
		insert into book
		(bookid,ISBN,title,author,pubdate,tags,image,binding,translator,publisher,author_intro,summary,price,ebook_price)
		value
		(#{book.bookId,jdbcType=VARCHAR},#{book.ISBN,jdbcType=VARCHAR},#{book.title,jdbcType=VARCHAR},
		#{book.author,jdbcType=VARCHAR},#{book.pubdate,jdbcType=VARCHAR},#{book.tags,jdbcType=VARCHAR},
		#{book.image,jdbcType=VARCHAR},#{book.binding,jdbcType=VARCHAR},#{book.translator,jdbcType=VARCHAR},
		#{book.publisher,jdbcType=VARCHAR},#{book.author_intro,jdbcType=VARCHAR},#{book.summary,jdbcType=VARCHAR},
		#{book.price,jdbcType=VARCHAR},#{book.ebook_price,jdbcType=VARCHAR})
	</insert>

	<insert id="saveBookStatus" parameterType="book">
		insert into bookstatus
		(bookid,status,addtime)
		value
		(#{book.bookId,jdbcType=VARCHAR},#{book.status,jdbcType=VARCHAR},#{book.addTime,jdbcType=VARCHAR})
	</insert>

	<select id="getAllBooks" resultType="Book">
		select
		b.*,s.*
		from book b
		left join bookstatus s
		on b.bookid=s.bookid
		<if test="ifNew!=null">
			where s.ifNew=1
		</if>
		<if test="status!=null">
			where s.status!=#{status}
		</if>
	</select>

	<select id="searchBooks" resultType="Book">
		select
		b.*,s.*
		from book b
		left join bookstatus s
		on b.bookid=s.bookid
		where b.title like concat(concat('%',#{title,jdbcType=VARCHAR}),'%')
		<if test="ifNew!=null">
			and s.ifNew=1
		</if>
	</select>

	<select id="searchBookDetails" resultType="Book">
		select
		b.*,s.*
		from book
		b
		left join bookstatus s
		on b.bookid=s.bookid
		where
		b.ISBN=#{ISBN,jdbcType=VARCHAR}
	</select>

	<select id="searchBookComments" resultType="Comment">
		select
		c.*
		from comment
		c
		left join book b
		on b.bookid=c.bookid
		where
		b.ISBN=#{ISBN,jdbcType=VARCHAR}
	</select>
	
	<select id="searchCommendBooks" resultType="java.util.Map">
		select
		b.*,c.*
		from book b
		left join commend c
		on b.bookid=c.bookid
		where
		c.userid=#{userId,jdbcType=VARCHAR}
	</select>

	<insert id="likeBook">
		insert into booklike
		(bookid,userid,status)
		select
		b.bookid,#{userId,jdbcType=VARCHAR},#{status}
		from book b
		where
		b.ISBN=#{ISBN,jdbcType=VARCHAR}
	</insert>
	
	<update id="updateBook">
		update bookstatus bs
		set bs.status=#{status}
		where
		bs.bookid=#{bookId,jdbcType=VARCHAR}
	</update>

	<update id="updateBorrow">
		update borrow br
		set br.status=#{status}
		where
		br.borrowid=#{borrowId,jdbcType=VARCHAR}
	</update>

	<update id="renew">
		update borrow br
		set br.renew="1"
		where
		br.borrowid=#{borrowId,jdbcType=VARCHAR}
	</update>


</mapper>